name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests
        run: python -m pytest tests/ -v --tb=short -x
        env:
          DATABASE_URL: "sqlite+aiosqlite:///./test.db"
          OLLAMA_BASE_URL: "http://localhost:11434"
          OLLAMA_MODEL: "llama3.2"
          UPLOAD_DIR: "./test_uploads"
          ARCHIVE_DIR: "./test_archive"

  build-images:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/backend:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ github.repository }}/backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/frontend:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ github.repository }}/frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create-release:
    runs-on: ubuntu-latest
    needs: build-images

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create release archive
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          REPO=${{ github.repository }}
          mkdir -p release

          # docker-compose.yml mit GHCR-Images statt build-Kontexten generieren
          cat > release/docker-compose.yml << 'COMPOSE_EOF'
          services:
            backend:
              image: ghcr.io/REPO_PLACEHOLDER/backend:VERSION_PLACEHOLDER
              ports:
                - "8000:8000"
              volumes:
                - ./data:/app/data
              env_file:
                - .env
              depends_on:
                ollama:
                  condition: service_started
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
                interval: 30s
                timeout: 5s
                retries: 3
                start_period: 15s

            ollama:
              image: ollama/ollama:latest
              volumes:
                - ollama-models:/root/.ollama
              restart: unless-stopped
              deploy:
                resources:
                  reservations:
                    devices:
                      - driver: nvidia
                        count: all
                        capabilities: [gpu]
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
                interval: 30s
                timeout: 5s
                retries: 3
                start_period: 10s

            frontend:
              image: ghcr.io/REPO_PLACEHOLDER/frontend:VERSION_PLACEHOLDER
              ports:
                - "${FRONTEND_PORT:-8080}:80"
              depends_on:
                backend:
                  condition: service_started
              restart: unless-stopped

          volumes:
            ollama-models:
          COMPOSE_EOF

          # Platzhalter ersetzen und Einrueckung fixen
          sed -i "s|REPO_PLACEHOLDER|${REPO}|g" release/docker-compose.yml
          sed -i "s|VERSION_PLACEHOLDER|${VERSION}|g" release/docker-compose.yml
          sed -i 's/^          //' release/docker-compose.yml

          # Installer-Dateien kopieren
          cp .env.example release/
          cp install.bat release/
          cp install.ps1 release/
          cp start.bat release/
          cp stop.bat release/
          cp update.bat release/
          cp uninstall.bat release/

          # Archive erstellen
          cd release
          tar -czf ../zettelwirtschaft-${VERSION}.tar.gz *
          zip -r ../zettelwirtschaft-${VERSION}.zip *

      - name: Generate changelog
        id: changelog
        run: |
          # Vorheriges Tag finden
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            CHANGES=$(git log --pretty=format:"- %s" HEAD)
          else
            CHANGES=$(git log --pretty=format:"- %s" ${PREV_TAG}..HEAD)
          fi
          echo "CHANGES<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Zettelwirtschaft v${{ steps.version.outputs.VERSION }}
          body: |
            ## Zettelwirtschaft v${{ steps.version.outputs.VERSION }}

            ### Aenderungen
            ${{ steps.changelog.outputs.CHANGES }}

            ### Installation

            1. Archiv herunterladen und entpacken
            2. `install.bat` doppelklicken
            3. Den Anweisungen des Assistenten folgen

            **Voraussetzung:** [Docker Desktop](https://www.docker.com/products/docker-desktop/) muss installiert sein.

            ### Docker Images

            ```
            ghcr.io/${{ github.repository }}/backend:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ github.repository }}/frontend:${{ steps.version.outputs.VERSION }}
            ```
          files: |
            zettelwirtschaft-${{ steps.version.outputs.VERSION }}.tar.gz
            zettelwirtschaft-${{ steps.version.outputs.VERSION }}.zip
          draft: false
          prerelease: false
